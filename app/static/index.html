<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSH-Shield Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --GREEN:  #3fb950;
      --YELLOW: #d29922;
      --ORANGE: #f0883e;
      --RED:    #f85149;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* ── Top-right threat monitor ── */
    #threat-monitor {
      position: fixed;
      top: 16px;
      right: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 18px;
      min-width: 260px;
      z-index: 100;
      box-shadow: 0 4px 24px #0008;
    }

    #threat-monitor .monitor-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    #level-badge {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    #score-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
    }

    #why-line  { color: var(--muted); font-size: 12px; margin-top: 4px; }
    #actions-line { color: var(--muted); font-size: 12px; margin-top: 4px; font-style: italic; }

    /* Gauge bar */
    .gauge-bar {
      margin-top: 10px;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      overflow: hidden;
    }
    .gauge-fill { height: 100%; border-radius: 3px; transition: width .6s ease, background .4s; }

    /* ── Main layout ── */
    header {
      padding: 20px 28px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1 { font-size: 20px; font-weight: 700; }
    header span { color: var(--muted); font-size: 13px; }

    main {
      padding: 24px 28px;
      max-width: 1400px;
    }

    section { margin-bottom: 32px; }
    section h2 { font-size: 15px; font-weight: 600; margin-bottom: 14px; color: var(--text); }

    /* ── Stats row ── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
    }

    .stat-card .label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .06em; }
    .stat-card .value { font-size: 26px; font-weight: 700; margin-top: 4px; }

    /* ── Chart ── */
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    /* ── Tables ── */
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      color: var(--muted);
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
    }

    td { padding: 7px 8px; border-bottom: 1px solid var(--border); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #ffffff08; }

    .table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      overflow: hidden;
    }

    .table-card h3 { font-size: 13px; font-weight: 600; margin-bottom: 10px; }

    /* ── Sessions accordion ── */
    .session-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .session-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      cursor: pointer;
      user-select: none;
    }

    .session-header:hover { background: #ffffff06; }

    .session-header .sid { font-family: monospace; font-size: 12px; color: var(--muted); }
    .session-header .ip  { font-weight: 600; font-size: 13px; }

    .session-body {
      display: none;
      padding: 10px 14px;
      border-top: 1px solid var(--border);
    }

    .session-body.open { display: block; }

    .event-row {
      display: flex;
      gap: 10px;
      font-size: 12px;
      font-family: monospace;
      padding: 3px 0;
    }

    .event-row .ets { color: var(--muted); min-width: 90px; }
    .kind-tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .kind-failed_auth { background:#f8514930; color:#f85149; }
    .kind-connect     { background:#3fb95030; color:#3fb950; }
    .kind-disconnect  { background:#8b949e30; color:#8b949e; }
    .kind-command     { background:#388bfd30; color:#388bfd; }
    .kind-login       { background:#d2992230; color:#d29922; }
    .kind-ban         { background:#bc8cff30; color:#bc8cff; }

    /* pulsing dot */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .live-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--GREEN);
      animation: pulse 2s infinite;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<!-- ── Top-right threat monitor ── -->
<div id="threat-monitor">
  <div class="monitor-header">
    <div class="live-dot" id="live-dot"></div>
    <span id="score-value">0</span>
    <span id="level-badge">GREEN</span>
  </div>
  <div class="gauge-bar"><div class="gauge-fill" id="gauge-fill" style="width:0%"></div></div>
  <div id="why-line" style="margin-top:8px">No activity detected</div>
  <div id="actions-line"></div>
</div>

<!-- ── Header ── -->
<header>
  <h1>SSH-Shield</h1>
  <span>Autonomous SSH Defense Dashboard</span>
</header>

<main>

  <!-- Stats cards -->
  <div class="stats-row">
    <div class="stat-card"><div class="label">Threat Score</div><div class="value" id="stat-score">0</div></div>
    <div class="stat-card"><div class="label">Fail Rate / min</div><div class="value" id="stat-fail">0</div></div>
    <div class="stat-card"><div class="label">Conn Rate / min</div><div class="value" id="stat-conn">0</div></div>
    <div class="stat-card"><div class="label">Unique IPs / 10m</div><div class="value" id="stat-uniq">0</div></div>
    <div class="stat-card"><div class="label">Bans / 10m</div><div class="value" id="stat-bans">0</div></div>
  </div>

  <!-- Timeline -->
  <section>
    <h2>Threat Score Timeline</h2>
    <div class="chart-card">
      <canvas id="timeline-chart" height="80"></canvas>
    </div>
  </section>

  <!-- Top IPs + Top Usernames -->
  <section>
    <div class="two-col">
      <div class="table-card">
        <h3>Top Offending IPs (last hour)</h3>
        <table>
          <thead><tr><th>IP</th><th>Events</th></tr></thead>
          <tbody id="top-ips-body"></tbody>
        </table>
      </div>
      <div class="table-card">
        <h3>Top Usernames Attempted (last hour)</h3>
        <table>
          <thead><tr><th>Username</th><th>Attempts</th></tr></thead>
          <tbody id="top-users-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Honeypot sessions -->
  <section>
    <h2>Honeypot Sessions (last 24 h)</h2>
    <div id="sessions-container"></div>
  </section>

</main>

<script>
const LEVEL_COLORS = {
  GREEN:  'var(--GREEN)',
  YELLOW: 'var(--YELLOW)',
  ORANGE: 'var(--ORANGE)',
  RED:    'var(--RED)',
};

// ── Chart setup ──────────────────────────────────────────────────────────────
const ctx = document.getElementById('timeline-chart').getContext('2d');
const timelineChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Threat Score',
      data: [],
      borderColor: '#388bfd',
      backgroundColor: '#388bfd18',
      tension: 0.3,
      pointRadius: 2,
      fill: true,
    }],
  },
  options: {
    responsive: true,
    animation: false,
    scales: {
      y: { min: 0, max: 100, grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
      x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } },
    },
    plugins: { legend: { display: false } },
  },
});

// ── Helpers ──────────────────────────────────────────────────────────────────
function fmtTime(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function setLevel(level) {
  const color = LEVEL_COLORS[level] || 'var(--GREEN)';
  const badge = document.getElementById('level-badge');
  badge.textContent = level;
  badge.style.background = color + '30';
  badge.style.color = color;
  document.getElementById('live-dot').style.background = color;
}

// ── Fetch + update status ─────────────────────────────────────────────────────
async function updateStatus() {
  try {
    const res = await fetch('/api/status');
    const d = await res.json();

    const score = Math.round(d.score);
    const level = d.level;
    const color = LEVEL_COLORS[level] || 'var(--GREEN)';

    document.getElementById('score-value').textContent = score;
    document.getElementById('stat-score').textContent = score;
    document.getElementById('why-line').textContent = d.why;
    document.getElementById('actions-line').textContent =
      d.actions.length ? 'Actions: ' + d.actions.slice(0,2).join(' | ') : '';
    setLevel(level);

    const fill = document.getElementById('gauge-fill');
    fill.style.width = score + '%';
    fill.style.background = color;

    document.getElementById('stat-fail').textContent = d.metrics.fail_rate ?? 0;
    document.getElementById('stat-conn').textContent = d.metrics.conn_rate ?? 0;
    document.getElementById('stat-uniq').textContent = d.metrics.unique_ips ?? 0;
    document.getElementById('stat-bans').textContent = d.metrics.ban_events ?? 0;

    // Top IPs
    const ipBody = document.getElementById('top-ips-body');
    ipBody.innerHTML = (d.top_ips || []).map(r =>
      `<tr><td>${r.ip}</td><td>${r.count}</td></tr>`
    ).join('');

    // Top users
    const uBody = document.getElementById('top-users-body');
    uBody.innerHTML = (d.top_users || []).map(r =>
      `<tr><td>${r.username}</td><td>${r.count}</td></tr>`
    ).join('');

  } catch(e) { console.warn('status fetch failed', e); }
}

// ── Fetch + update timeline ───────────────────────────────────────────────────
async function updateTimeline() {
  try {
    const res = await fetch('/api/timeline?limit=120');
    const rows = await res.json();
    timelineChart.data.labels = rows.map(r => fmtTime(r.ts));
    timelineChart.data.datasets[0].data = rows.map(r => r.score);
    timelineChart.update();
  } catch(e) { console.warn('timeline fetch failed', e); }
}

// ── Fetch + update sessions ───────────────────────────────────────────────────
async function updateSessions() {
  try {
    const res = await fetch('/api/sessions');
    const sessions = await res.json();
    const container = document.getElementById('sessions-container');
    if (!sessions.length) {
      container.innerHTML = '<p style="color:var(--muted);font-size:13px">No sessions yet.</p>';
      return;
    }
    container.innerHTML = sessions.map(s => {
      const evHTML = s.events.map(ev => {
        const meta = ev.meta || {};
        const detail = meta.input || meta.username || meta.password || '';
        return `<div class="event-row">
          <span class="ets">${fmtTime(ev.ts)}</span>
          <span class="kind-tag kind-${ev.kind}">${ev.kind}</span>
          <span>${detail}</span>
        </div>`;
      }).join('');

      return `<div class="session-item">
        <div class="session-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span class="ip">${s.src_ip}</span>
          <span class="sid">${s.session}</span>
          <span style="color:var(--muted);font-size:12px;margin-left:auto">${s.events.length} events · ${fmtTime(s.start)}</span>
        </div>
        <div class="session-body">${evHTML}</div>
      </div>`;
    }).join('');
  } catch(e) { console.warn('sessions fetch failed', e); }
}

// ── Poll loop ─────────────────────────────────────────────────────────────────
async function tick() {
  await Promise.all([updateStatus(), updateTimeline()]);
}

updateSessions();            // sessions are heavier, refresh less often
setInterval(updateSessions, 15000);
tick();
setInterval(tick, 3000);
</script>
</body>
</html>
